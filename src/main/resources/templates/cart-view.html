<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>×ª×¦×•×’×ª ×œ×§×•×—</title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/print.css" media="print">

    <script src="https://cdn.jsdelivr.net/npm/sockjs-client/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs/lib/stomp.min.js"></script>
</head>
<body>
<!-- HEADER -->
<div th:replace="~{fragments/header :: header}"></div>

<div class="main container">
    <h2>×¨×›×™×©×” × ×•×›×—×™×ª</h2>

    <table id="cart-table">
        <thead>
        <tr>
            <th>×›××•×ª</th>
            <th>×©×</th>
            <th>××—×™×¨</th>
            <th>×¡×”"×›</th>
        </tr>
        </thead>
        <tbody id="cart-body">
        <!-- ×™×ª××œ× ×‘×–××Ÿ ×××ª -->
        </tbody>
    </table>

    <p style="margin-top: 20px; font-size: 20px;"><strong>×¡×”×´×› ×œ×ª×©×œ×•×:</strong> â‚ª <span id="total-amount">0.00</span></p>
</div>

<script>
    const socket = new SockJS('/ws');
    const stompClient = Stomp.over(socket);

    stompClient.connect({}, function () {
        console.log("ğŸ”Œ WebSocket connected");

        stompClient.subscribe('/topic/cart', function (message) {
            try {
                const items = JSON.parse(message.body);
                console.log("ğŸ“¦ Received cart items:", items);

                const tbody = document.getElementById('cart-body');
                const totalEl = document.getElementById('total-amount');
                tbody.innerHTML = '';

                let total = 0;

                items.forEach(item => {
                    const tr = document.createElement('tr');

                    // ×›××•×ª
                    const quantityTd = document.createElement('td');
                    quantityTd.textContent = item.quantity;

                    // ×©× ××•×¦×¨
                    const nameTd = document.createElement('td');
                    nameTd.textContent = item.productName;

                    // ××—×™×¨ ×™×—×™×“×” (×¢×/×‘×œ×™ ××‘×¦×¢)
                    const priceTd = document.createElement('td');
                    if (item.discountApplied) {
                        priceTd.innerHTML = `
                            <span class="strikethrough">â‚ª${(item.originalPrice / item.quantity).toFixed(2)}</span>
                            â‚ª${(item.totalPrice / item.quantity).toFixed(2)}
                            <span>(${item.discountDescription})</span>
                        `;
                    } else {
                        priceTd.textContent = `â‚ª${(item.totalPrice / item.quantity).toFixed(2)}`;
                    }

                    // ××—×™×¨ ×›×•×œ×œ
                    const totalTd = document.createElement('td');
                    if (item.discountApplied) {
                        totalTd.innerHTML = `
                            <span class="strikethrough">â‚ª${item.originalPrice.toFixed(2)}</span>
                            â‚ª${item.totalPrice.toFixed(2)}
                        `;
                    } else {
                        totalTd.textContent = `â‚ª${item.totalPrice.toFixed(2)}`;
                    }

                    total += item.totalPrice;

                    tr.appendChild(quantityTd);
                    tr.appendChild(nameTd);
                    tr.appendChild(priceTd);
                    tr.appendChild(totalTd);

                    tbody.appendChild(tr);
                });

                totalEl.textContent = total.toFixed(2);

            } catch (e) {
                console.error("âŒ Failed to parse WebSocket message", e);
                console.log("ğŸ“„ Raw message body:", message.body);
            }
        });
    }, function (err) {
        console.error("âŒ WebSocket connection error", err);
    });
</script>

</body>
</html>
